---
title: "tree"
author: "Baoyi Shi"
date: "2018年12月2日"
output: html_document
---

```{r }
library(tidyverse)
library(dplyr)
library(readr)
library(readxl)
library(ggplot2)
```

```{r }
#import tree data, retain only trees alive and good to health
tree_df = read_csv("./data/2015StreetTreesCensus_TREES.csv") %>%
  janitor::clean_names() %>%
  filter(status == "Alive", health == "Good") 
```

```{r }
#compute the total tree number of each boro
tree_df %>%
  group_by(boroname) %>%
  dplyr::summarise(total = n()) 
```

```{r }
ggplot(aes(x = latitude, y = longitude), data = tree_df) +
  geom_hex()
```

```{r }
asthma_pollutes_df = read_csv("./data/asthma_pollutes_34.csv") %>%
  janitor::clean_names()

asthma = asthma_pollutes_df %>%
  filter(measure == "Percent")

ozone = asthma_pollutes_df %>%
  filter(name == "Ozone (O3)")

pm = asthma_pollutes_df %>%
  filter(name == "Fine Particulate Matter (PM2.5)")

no2 = asthma_pollutes_df %>%
  filter(name == "Nitrogen Dioxide (NO2)")

no = asthma_pollutes_df %>%
  filter(name == "Nitric Oxide (NO)")

df_ozone = left_join(asthma, ozone, by = "geo_entity_name") %>%
  filter(is.na(data_value.x) == FALSE, is.na(data_value.y) == FALSE)

ggplot(data = df_ozone, aes(x = data_value.x, y = data_value.y)) +
  geom_point() +
  geom_smooth()

df_pm = left_join(asthma, pm, by = "geo_entity_name") %>%
  filter(is.na(data_value.x) == FALSE, is.na(data_value.y) == FALSE)

ggplot(data = df_pm, aes(x = data_value.x, y = data_value.y)) +
  geom_point() +
  geom_smooth()

df_no2 = left_join(asthma, no2, by = "geo_entity_name") %>%
  filter(is.na(data_value.x) == FALSE, is.na(data_value.y) == FALSE)

ggplot(data = df_no2, aes(x = data_value.x, y = data_value.y)) +
  geom_point() +
  geom_smooth()

df_no = left_join(asthma, no, by = "geo_entity_name") %>%
  filter(is.na(data_value.x) == FALSE, is.na(data_value.y) == FALSE)

ggplot(data = df_no, aes(x = data_value.x, y = data_value.y)) +
  geom_point() +
  geom_smooth()
```

```{r }
zipcode_uhf42 = read_excel("./data/Zipcode_UHF42.xlsx") %>%
   gather(key = zipcode_no, value = zipcode, zipcode1:zipcode9) %>%
   select(-zipcode_no, -uhf42_code) %>%
   filter(is.na(zipcode) == FALSE)

tree_total_uhf42 = left_join(tree_df, zipcode_uhf42, by = "zipcode") %>%
  group_by(uhf42_name) %>%
  dplyr::summarize(total = n()) %>%
  filter(is.na(uhf42_name) == FALSE) %>%
  mutate(uhf42_name = forcats::fct_reorder(uhf42_name, total))

ggplot(aes(x = uhf42_name, y = total), data = tree_total_uhf42) +
  geom_bar(stat = "identity", aes(fill = uhf42_name)) +
  theme(axis.text.x = element_text(angle = 75, hjust = 1)) +
  theme(legend.position = "none")
```

```{r }
zipcode_uhf42 = read_excel("./data/Zipcode_UHF42.xlsx") %>%
   gather(key = zipcode_no, value = zipcode, zipcode1:zipcode9) %>%
   select(-zipcode_no, -uhf42_code) %>%
   filter(is.na(zipcode) == FALSE)

mydat = rgdal::readOGR("./UHF42/UHF_42_DOHMH.shp")
area = mydat$SHAPE_Area



tree_total_uhf42 = left_join(tree_df, zipcode_uhf42, by = "zipcode") %>%
  group_by(uhf42_name) %>%
  dplyr::summarize(total = n()) %>%
  mutate(area = mydat$SHAPE_Area) %>%
  filter(is.na(uhf42_name) == FALSE) %>%
  mutate(tree_density = total/area, 
         uhf42_name = forcats::fct_reorder(uhf42_name, tree_density))

ggplot(aes(x = uhf42_name, y = tree_density), data = tree_total_uhf42) +
  geom_bar(stat = "identity", aes(fill = uhf42_name)) +
  theme(axis.text.x = element_text(angle = 75, hjust = 1)) +
  theme(legend.position = "none")
```

```{r }
asthma_pollute = read_csv("./data/asthma_air/Data.csv")

pm2.5 = asthma_pollute %>%
  filter(name == "Fine Particulate Matter (PM2.5)", Measure == "Mean", year_description == "Annual Average 2015") %>%
  dplyr::rename(uhf42_name = geo_entity_name) %>%
  select(uhf42_name, pm2.5_data = data_value)

pm2.5_tree = left_join(pm2.5, tree_total_uhf42)

summary(lm(pm2.5_data ~ tree_density, data = pm2.5_tree))

ggplot(aes(x = tree_density, y = pm2.5_data), data = pm2.5_tree) +
  geom_point()+
  geom_smooth()

asthma_hos_children = asthma_pollute %>%
  filter(name == "Asthma Hospitalizations (Children 0 to 4 Yrs Old)", Measure == "Rate", year_description == "2015") %>%
  dplyr::rename(uhf42_name = geo_entity_name) %>%
  select(uhf42_name, asthma_hos_children = data_value)

asthma_hos_children_tree = left_join(asthma_hos_children, tree_total_uhf42)

summary(lm(asthma_hos_children ~ tree_density, data = asthma_hos_children_tree))

ggplot(aes(x = tree_density, y = asthma_hos_children), data = asthma_hos_children_tree) +
  geom_point()+
  geom_smooth()
```