---
title: "Dashboard"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
---

```{r dashboard setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(rvest)
library(httr)
library(plotly)
library(rgdal)
library(patchwork)
library(readxl)

```

```{r tidy,include= FALSE}
mydat = rgdal::readOGR("./UHF42/UHF_42_DOHMH.shp")
map_data = fortify(mydat) %>%
  dplyr::select(id, everything() )%>%
  nest(long:group)
map_data$uhf = mydat$UHFCODE
map_data = map_data %>%
  unnest %>%
  dplyr::select(-id) %>%
  dplyr::select(id = uhf, everything()) %>%
  dplyr::select(long, lat, everything())

names(map_data)[1:2] = c("x","y") 

asthma_air = read_csv("./data/asthma_air/Data.csv") %>%
  filter(str_detect(year_description, "^20|^An")) %>%
  mutate(year_description = str_remove(year_description, "Annual Average ")) %>%
    filter(year_description == 2015)

sulfur_dioxide= read_csv("./data/asthma_air/Data.csv") %>%
  filter(name == "Sulfur Dioxide (SO2)") %>%
  filter(year_description == "Winter 2014-15")

ozone= read_csv("./data/asthma_air/Data.csv") %>%
  filter(name == "Ozone (O3)") %>%
  filter(year_description == "Summer 2015")

poverty= read_csv("./data/poverty/Data.csv") %>%
  filter(year_description == "2011-15" )

smoke = read_csv("./data/smoking_exer/Data.csv") %>%
  filter(year_description == "2015" )

data = rbind(asthma_air,sulfur_dioxide,ozone, poverty, smoke)
  
asthma_air1 = data %>%
  select(name, description, Measure, geo_entity_name, geo_entity_id, year = year_description, data_value) %>%
  janitor::clean_names() %>% 
  filter(measure %in% c("Mean", "Rate", "Number", "Percent", "Age-Adjusted Percent", "Age-Adjusted Rate ")) %>%
  mutate(name_measure=str_c(name,"-",measure)) %>%
  select(-name, -measure, -description, -year) %>%
  spread(key = name_measure, value = data_value) %>%
  janitor::clean_names()

asthma_map = asthma_air1 %>%
  dplyr::select (id = geo_entity_id, asthma = asthma_emergency_department_visits_children_0_to_4_yrs_old_rate)
asthma_air = read_csv("./data/asthma_air/Data.csv") %>%
  filter(str_detect(year_description, "^20|^An")) %>%
  mutate(year_description = str_remove(year_description, "Annual Average "))

tree_df = read_csv("./data/2015StreetTreesCensus_TREES.csv") %>%
  janitor::clean_names() %>%
  filter(status == "Alive", health == "Good") 
  
zipcode_uhf42 = read_excel("./data/Zipcode_UHF42.xlsx") %>%
   gather(key = zipcode_no, value = zipcode, zipcode1:zipcode9) %>%
   dplyr::select(-zipcode_no, -uhf42_code) %>%
   filter(is.na(zipcode) == FALSE)

mydat = rgdal::readOGR("./UHF42/UHF_42_DOHMH.shp")
area = mydat$SHAPE_Area

tree_total_uhf42 = left_join(tree_df, zipcode_uhf42, by = "zipcode") %>%
  group_by(uhf42_name) %>%
  dplyr::summarize(total = n()) %>%
  mutate(area = mydat$SHAPE_Area) %>%
  filter(is.na(uhf42_name) == FALSE) %>%
  mutate(tree_density = total/area, 
         uhf42_name = forcats::fct_reorder(uhf42_name, tree_density))
```


```

Column {.tabset data-width=650}
-----------------------------------------------------------------------

### Chart A

```{r}
ggplot(asthma_map) +
    geom_map(aes(map_id = id, fill = asthma), color = "white", map = map_data) +
    scale_fill_gradient(high = "darkgreen",low = "lightgreen") +
    expand_limits(map_data)
```


### Chart B

```{r}

ggplot(aes(x = uhf42_name, y = tree_density), data = tree_total_uhf42) +
  geom_bar(stat = "identity", aes(fill = uhf42_name)) +
  theme(axis.text.x = element_text(angle = 75, hjust = 1)) +
  theme(legend.position = "none")

```

Column {data-width=550}
-----------------------------------------------------------------------
### Chart C

```{r fig.width=8.5, fig.height=3.5}
 plot_so2 = ggplot(asthma_air1 )+
  geom_point(aes(x = sulfur_dioxide_so2_mean, y =asthma_emergency_department_visits_children_0_to_4_yrs_old_rate,color = "children_0_to_4_yrs_old"))+
  geom_smooth(aes(x = sulfur_dioxide_so2_mean, y = asthma_emergency_department_visits_children_0_to_4_yrs_old_rate,color = "children_0_to_4_yrs_old"),method = lm,se =FALSE) +
  geom_point(aes(x = sulfur_dioxide_so2_mean, y = asthma_emergency_department_visits_children_5_to_14_yrs_old_rate,color = "children_5_to_14_yrs_old"))+
  geom_smooth(aes(x = sulfur_dioxide_so2_mean, y = asthma_emergency_department_visits_children_5_to_14_yrs_old_rate,color = "children_5_to_14_yrs_old"),method = lm,se =FALSE) +
  theme(legend.position ="bottom")
  ggplotly(plot_so2,height = 200, width=450) %>%
layout(legend = list(orientation = "h", x = -0.5, y =-1))
```


### Chart D {.tabset}

```{r}

```

### Chart E 

```{r}

```
